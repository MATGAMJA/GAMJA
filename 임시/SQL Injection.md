# **SQL Injection**

## 개념

SQL Injection은 사용자의 입력값이 서버 측에서 코드로 실행되는 **코드 인젝션** 공격 기법 중 하나이며, 서버의 데이터베이스를 대상으로 하는 공격이다. 사용자의 입력값을 제대로 필터링, 이스케이프 하지 않아 발생한다. 공격의 핵심은 클라이언트 측에서 SQL 쿼리에 신뢰할 수 없는 데이터가 입력되었을 때, 데이터가 쿼리 로직의 일부로 해석되어 DB에서 실행될 때 발생한다.

## 공격 목적

SQL Injection 공격 목적은 다음과 같다. SQL 구문에 추가 절을 삽입하게 되면 쿼리의 의미가 변경되고 의도하지 않은 데이터의 유출, 변조가 가능하다.

1. 정보 유출
2. 저장된 데이터 유출 및 조작
3. 원격 코드 실행
    - 일부 데이터베이스의 경우 확장 프로시져를 이용하여 원격으로 시스템 명령의 실행이 가능하다.
    - 시스템 명령의 실행은 원격 자원 접근 및 데이터 유출, 삭제가 가능하다.
4. 인증 우회
    - 공격의 대표적인 경우로 로그인 폼 등에서 발생한다.
    - 상위 권한을 가진 사용자의 권한으로 인증 절차를 우회하여 로그인 정보 없이 로그인할 수 있다.

## 대응 방안

가장 쉽고 빠른 보안대책은 Prepared Statement의 적용이다.

- Prepared Statement : 쿼리 실행계획 분석과 컴파일이 완료되어 DBMS의 캐시에 준비되어 있는 쿼리를 사용한다는 의미

Prepared Statement 또는 매개변수화된 구문을 사용해서 동일한 구문을 실행함에 있어서 SQLi 공격을 방지하고 높은 효율성으로 쿼리문을 실행하도록 한다. 바인딩 된 변수는 쿼리와 별도로 서버로 전송되므로 사용자가 입력한 구문이 쿼리로 실행될 수가 없다. 서버는 쿼리 템플릿이 모두 분석된 이후 실행 시점에서 사용자 입력값을 사용한다. 바인딩 된 매개변수는 쿼리 문자열로 삽입되지 않음으로 이스케이프 할 필요가 없다. 이는 쿼리 실행에서도 장점이 있음으로 공식 홈페이지에서도 권장된다.

![](https://github.com/ssafy-nice-guys-cs-study/discussions/assets/96599232/b81229b1-705a-4be8-8175-e8890d4ebed1)

언어별로 권장하는 Prepared Statement 사용법을 제시한다.

- [PHP](https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php)
- [C#](https://learn.microsoft.com/en-us/dotnet/api/system.data.sqlclient.sqlcommand.prepare?view=netframework-4.8)
- [Golang](https://pkg.go.dev/database/sql#DB.Prepare)
- [Java](https://docs.oracle.com/en/java/javase/12/docs/api/java.sql/java/sql/PreparedStatement.html)

하지만 개발 구조상 Prepared Statement의 적용이 어려운 경우가 있다. 그에 따른 대체 방법은 다음과 같다.
 모든 대응 방안은 **사용자 측에서 전달되는 모든 입력값은 신뢰 금지**가 원칙이다.

### 1. 블랙리스트 & 화이트리스트 기반 필터링

블랙리스트는 SQL 쿼리의 구조를 변경하는 특수문자, SQL 예약어 등을 미리 등록해놓고 입력을 제한하는 방식이다. 해당 문자가 입력되었을 때 에러 메시지를 반환하거나, 미리 준비한 문자열로 치환하는 방법이 있다.

```sql
(특수문자) ' , " , = , & , | , ! , ( , ) , { , } , $ , % , @ , #, -- 등
(예 약 어) UNION, GROUP BY, IF, COLUMN, END, INSTANCE 등
(함 수 명) DATABASE(), CONCAT(), COUNT(), LOWER() 등
```

화이트리스트 방식은 블랙리스트보다 좀 더 강력하지만 이용자 편의성이 떨어지는 방식이다. 허용하는 문자열을 미리 등록해놓고 리스트 이외의 문자열이 입력되었을 때 차단한다. 사이트 기능에 따라 하나로 정의된 사전 목록을 사용할 수 없기 때문에 패턴화, 정규화한 문자열을 사용하는 것을 권장한다.

### 2. 오류 메시지 출력 제한

DB 오류 메시지의 노출은 공격자에게 2차 공격을 할 수 있는 정보를 제공함으로 오류 메시지의 출력을 금지한다. DB 버전 정보, DB 종류 등을 포함하여 로그인 시 ID, Password 오류 여부도 불필요한 경우 노출하지 않는다.

### 3. DB 보안 적용

관리자 DB 계정과 웹 애플리케이션 운영 계정의 권한을 분리하여 운영한다. DDL, DML 등 사용하는 구문 별 계정을 구분하여 운영한다. 이외에도 웹 방화벽 사용, 주기적 로그 점검, 취약점 점검 등을 적용할 수 있다.</div>
